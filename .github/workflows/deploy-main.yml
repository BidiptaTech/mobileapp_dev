name: 🚀 Deploy Laravel to Azure Web App - Root Path

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      # 1️⃣ Checkout code
      - name: 📅 Checkout main branch
        uses: actions/checkout@v4

      # 2️⃣ Setup PHP
      - name: 🧠 Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      # 3️⃣ Install Composer globally
      - name: 🔧 Install Composer
        run: |
          curl -sS https://getcomposer.org/installer | php
          mv composer.phar /usr/local/bin/composer

      # 4️⃣ Install Composer dependencies
      - name: 📦 Composer install
        run: |
          composer validate --no-check-publish
          composer install --prefer-dist --no-dev --optimize-autoloader

      # 5️⃣ Create ZIP for deployment
      - name: 📦 Create ZIP for deployment
        run: |
          zip -r release.zip . \
            -x ".git/*" \
            -x "node_modules/*" \
            -x "tests/*" \
            -x "*.md" \
            -x ".github/*" \
            -x ".gitignore" \
            -x ".gitattributes" \
            -x ".editorconfig" \
            -x "phpunit.xml" \
            -x "vite.config.js" \
            -x "package*.json"

      # 6️⃣ Login to Azure
      - name: 🔐 Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 7️⃣ Deploy ZIP to Azure at /home/site/wwwroot
      - name: 🚀 Deploy ZIP to Azure Web App
        run: |
          az webapp deploy \
            --resource-group rg-dmc-mobile-dev \
            --name rg-dmc-mobile-dev \
            --src-path release.zip \
            --type zip

      # 8️⃣ Create default NGINX config
      - name: ⚙️ Create default NGINX file
        run: |
          cat > /home/site/wwwroot/default << 'EOF'
          server {
              listen 8080;
          
              root /home/site/wwwroot/public;
              index index.php index.html index.htm;
          
              server_name _;
          
              location / {
                  try_files $uri $uri/ /index.php?$query_string;
              }
          
              location ~ \.php$ {
                  include fastcgi_params;
                  fastcgi_pass 127.0.0.1:9000;
                  fastcgi_index index.php;
                  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              }
          
              location ~ /\.ht {
                  deny all;
              }
          }
          EOF

      # 9️⃣ Copy default file to NGINX and restart
      - name: 🔄 Apply NGINX config and restart
        run: |
          cp /home/site/wwwroot/default /etc/nginx/sites-available/default
          cp /home/site/wwwroot/default /etc/nginx/sites-enabled/default
          nginx -t && service nginx restart || echo "NGINX restart failed"

      # 🔟 Laravel cache clear & optimize (without touching .env)
      - name: 🧹 Laravel cache clear & optimize
        run: |
          cd /home/site/wwwroot || exit 1
          php artisan cache:clear || true
          php artisan config:clear || true
          php artisan route:clear || true
          php artisan view:clear || true
          php artisan optimize || true
          php artisan config:cache || true
          php artisan route:cache || true
          php artisan view:cache || true
          php artisan storage:link || true

      # 1️⃣1️⃣ Restart Azure Web App
      - name: 🔄 Restart Web App
        run: |
          az webapp restart --resource-group rg-dmc-mobile-dev --name rg-dmc-mobile-dev

      # 1️⃣2️⃣ Verify deployment
      - name: ✅ Verify Deployment
        run: |
          sleep 30
          curl -f https://mobiledev.travclicks.com/ || echo "Application may still be starting"

      # 1️⃣3️⃣ Deployment Summary
      - name: 📦 Deployment Summary
        run: |
          echo "🎉 Deployment finished!"
          echo "🌍 App URL: https://mobiledev.travclicks.com"
          echo "✔️ Laravel root path ready, caches cleared and optimized"
          echo "🛠️ Default NGINX applied, storage linked, and permissions set"
