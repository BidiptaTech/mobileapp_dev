name: 🚀 Deploy MAIN - Laravel to Azure (rg-dmc-mobile-dev)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: 🌐 Laravel MAIN Deployment
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    env:
      PHP_VERSION: '8.4'

    steps:
      - name: 📥 Checkout MAIN branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔧 Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, bcmath, xml, ctype, json
          ini-values: post_max_size=256M, upload_max_filesize=256M, memory_limit=2G
          coverage: none

      - name: 🔧 Install Composer Globally
        run: |
          curl -sS https://getcomposer.org/installer | php
          mv composer.phar /usr/local/bin/composer

      - name: 📦 Install Laravel Dependencies
        run: |
          composer validate --no-check-publish
          composer install --prefer-dist --no-dev --optimize-autoloader

      - name: 📁 Prepare Deployment Package
        run: |
          mkdir -p deployment
          cp -r * deployment/
          echo "✅ Deployment package prepared"

      - name: 🔐 Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: 🚀 Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'rg-dmc-mobile-dev'
          slot-name: 'Production'
          package: ./deployment

      - name: 🔄 Clear and Optimize Laravel
        run: |
          echo "🔧 Running Laravel cache & optimization commands..."
          php artisan cache:clear
          php artisan route:clear
          php artisan config:clear
          php artisan view:clear
          php artisan clear-compiled
          php artisan optimize:clear
          echo "✅ Laravel cache cleared and optimized"

      - name: 🔄 Restart Azure Web App
        run: az webapp restart --resource-group rg-dmc-mobile-dev --name rg-dmc-mobile-dev

      - name: ✅ Verify Deployment
        run: |
          sleep 30
          curl -f https://your-app-url/ || echo "Laravel app may still be starting"
