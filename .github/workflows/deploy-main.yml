name: 🚀 Deploy Laravel to Azure Web App - Root Path

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      # 1️⃣ Checkout code
      - name: 📅 Checkout main branch
        uses: actions/checkout@v4

      # 2️⃣ Setup PHP
      - name: 🧠 Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      # 3️⃣ Install Composer globally
      - name: 🔧 Install Composer
        run: |
          curl -sS https://getcomposer.org/installer | php
          mv composer.phar /usr/local/bin/composer

      # 4️⃣ Install Composer dependencies
      - name: 📦 Composer install
        run: |
          composer validate --no-check-publish
          composer install --prefer-dist --no-dev --optimize-autoloader

      # 5️⃣ Create ZIP for deployment
      - name: 📦 Create ZIP for deployment
        run: |
          zip -r release.zip . \
            -x ".git/*" \
            -x "node_modules/*" \
            -x "tests/*" \
            -x "*.md" \
            -x ".github/*" \
            -x ".gitignore" \
            -x ".gitattributes" \
            -x ".editorconfig" \
            -x "phpunit.xml" \
            -x "vite.config.js" \
            -x "package*.json"

      # 6️⃣ Login to Azure
      - name: 🔐 Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 7️⃣ Deploy ZIP to Azure
      - name: 🚀 Deploy ZIP to Azure Web App
        run: |
          az webapp deploy \
            --resource-group rg-dmc-mobile-dev \
            --name rg-dmc-mobile-dev \
            --src-path release.zip \
            --type zip

      # 8️⃣ Create startup.sh for Laravel
      - name: ⚙️ Create startup.sh
        run: |
          cat > startup.sh << 'EOF'
          #!/bin/bash
          echo "🚀 Laravel setup on Azure Web App (root path)..."

          # Remove startup script if already exists
          rm -f /home/site/wwwroot/startup.sh

          # Create required directories with permissions
          mkdir -p /home/site/wwwroot/storage/framework/{sessions,views,cache/data}
          mkdir -p /home/site/wwwroot/storage/{logs,app/public} /home/site/wwwroot/bootstrap/cache
          chmod -R 775 /home/site/wwwroot/storage /home/site/wwwroot/bootstrap/cache

          cd /home/site/wwwroot

          # Write environment variables to .env
          cat > .env << ENV_EOF
          APP_NAME=Travclicks
          APP_ENV=production
          APP_KEY=${{ secrets.APP_KEY }}
          APP_DEBUG=false
          APP_URL=https://mobiledev.travclicks.com/
          LOG_CHANNEL=stack
          LOG_LEVEL=debug
          DB_CONNECTION=pgsql
          DB_HOST=db-dmc-dev.postgres.database.azure.com
          DB_PORT=5432
          DB_DATABASE=travclicks_db_dev
          DB_USERNAME=travadm_pg_dev
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          BROADCAST_DRIVER=log
          CACHE_DRIVER=file
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=sync
          SESSION_DRIVER=file
          SESSION_LIFETIME=120
          REDIS_HOST=127.0.0.1
          MAIL_MAILER=smtp
          MAIL_HOST=smtp.hostinger.com
          MAIL_PORT=465
          MAIL_USERNAME=admin@travclicks.com
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_ENCRYPTION=SSL
          MAIL_FROM_ADDRESS=admin@travclicks.com
          MAIL_FROM_NAME=Travclicks
          AWS_DEFAULT_REGION=us-east-1
          AZURE_STORAGE_NAME=stgdmcappdev
          AZURE_STORAGE_KEY=${{ secrets.AZURE_STORAGE_KEY }}
          AZURE_STORAGE_CONTAINER=uploads
          AZURE_STORAGE_ENDPOINT=https://stgdmcappdev.blob.core.windows.net/
          ENV_EOF

          # Generate APP_KEY if missing
          if ! grep -q "APP_KEY=base64:" .env 2>/dev/null; then
              php artisan key:generate --force || true
          fi

          # Clear and optimize Laravel caches
          php artisan cache:clear || true
          php artisan route:clear || true
          php artisan view:clear || true
          php artisan config:clear || true
          php artisan optimize || true
          php artisan config:cache || true
          php artisan route:cache || true
          php artisan view:cache || true

          # Create storage symlink
          php artisan storage:link || true

          echo "✅ Laravel setup and optimization complete"
          EOF
          chmod +x startup.sh

      # 9️⃣ Upload and run startup.sh
      - name: 📄 Upload and run startup script
        run: |
          az webapp deploy \
            --resource-group rg-dmc-mobile-dev \
            --name rg-dmc-mobile-dev \
            --src-path startup.sh \
            --type startup

      # 🔄 Restart Azure Web App
      - name: 🔄 Restart Web App
        run: |
          az webapp restart --resource-group rg-dmc-mobile-dev --name rg-dmc-mobile-dev

      # 🔎 Verify deployment
      - name: ✅ Verify Deployment
        run: |
          sleep 30
          curl -f https://mobiledev.travclicks.com/ || echo "Application may still be starting"

      # 📦 Deployment Summary
      - name: 📦 Deployment Summary
        run: |
          echo "🎉 Deployment finished!"
          echo "🌍 App URL: https://mobiledev.travclicks.com"
          echo "✔️ Laravel root path ready, caches cleared and optimized"
          echo "🛠️ Directories created, permissions set"
