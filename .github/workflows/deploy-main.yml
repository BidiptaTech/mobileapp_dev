name: üöÄ Deploy Laravel MAIN to Azure (rg-dmc-mobile-dev)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: üåê Laravel MAIN Deployment
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    env:
      PHP_VERSION: '8.4'

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: üì• Checkout MAIN branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup PHP
      - name: üîß Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, bcmath, xml, ctype, json, pdo_pgsql
          ini-values: post_max_size=256M, upload_max_filesize=256M, memory_limit=2G
          coverage: none

      # 3Ô∏è‚É£ Install Composer
      - name: üíæ Install Composer
        run: |
          curl -sS https://getcomposer.org/installer | php
          mv composer.phar /usr/local/bin/composer

      # 4Ô∏è‚É£ Install Laravel Dependencies
      - name: üì¶ Install Dependencies
        run: |
          composer validate --no-check-publish
          composer install --prefer-dist --no-dev --optimize-autoloader

      # 5Ô∏è‚É£ Prepare Deployment Package
      - name: üìÅ Prepare Deployment Package
        run: |
          mkdir -p deployment
          rsync -av --progress --exclude 'deployment' ./ ./deployment/
          echo "‚úÖ Deployment package prepared"

      # 6Ô∏è‚É£ Azure Login
      - name: üîê Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 7Ô∏è‚É£ Configure Azure App Settings
      - name: üåø Configure Azure App Settings
        run: |
          az webapp config appsettings set \
            --resource-group rg-dmc-mobile-dev \
            --name rg-dmc-mobile-dev \
            --settings \
          APP_NAME=Travclicks \
          APP_ENV=production \
          APP_KEY="${{ secrets.APP_KEY }}" \
          APP_DEBUG=false \
          APP_URL=https://mobiledev.travclicks.com/ \
          LOG_CHANNEL=stack \
          LOG_LEVEL=debug \
          DB_CONNECTION=pgsql \
          DB_HOST=db-dmc-dev.postgres.database.azure.com \
          DB_PORT=5432 \
          DB_DATABASE=travclicks_db_dev \
          DB_USERNAME=travadm_pg_dev \
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
          BROADCAST_DRIVER=log \
          CACHE_DRIVER=file \
          FILESYSTEM_DISK=local \
          QUEUE_CONNECTION=sync \
          SESSION_DRIVER=file \
          SESSION_LIFETIME=120 \
          REDIS_HOST=127.0.0.1 \
          MAIL_MAILER=smtp \
          MAIL_HOST=smtp.hostinger.com \
          MAIL_PORT=465 \
          MAIL_USERNAME="admin@travclicks.com" \
          MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}" \
          MAIL_ENCRYPTION=SSL \
          MAIL_FROM_ADDRESS="admin@travclicks.com" \
          MAIL_FROM_NAME="Travclicks" \
          AWS_DEFAULT_REGION=us-east-1 \
          AZURE_STORAGE_NAME=stgdmcappdev \
          AZURE_STORAGE_KEY="${{ secrets.AZURE_STORAGE_KEY }}" \
          AZURE_STORAGE_CONTAINER=uploads \
          AZURE_STORAGE_ENDPOINT=https://stgdmcappdev.blob.core.windows.net/

      # 8Ô∏è‚É£ Deploy Laravel to Azure Web App
      - name: üöÄ Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'rg-dmc-mobile-dev'
          slot-name: 'Production'
          package: ./deployment

      # 9Ô∏è‚É£ Clear & optimize Laravel caches (force PostgreSQL)
      - name: üîÑ Clear and Optimize Laravel
        run: |
          echo "üîß Running Laravel cache & optimization commands..."
          php artisan config:clear
          php artisan cache:clear
          php artisan route:clear
          php artisan view:clear
          php artisan clear-compiled
          php artisan optimize:clear
          echo "‚úÖ Laravel cache cleared and optimized"
        env:
          APP_ENV: production
          APP_DEBUG: false
          DB_CONNECTION: pgsql
          DB_HOST: db-dmc-dev.postgres.database.azure.com
          DB_PORT: 5432
          DB_DATABASE: travclicks_db_dev
          DB_USERNAME: travadm_pg_dev
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

      # üîü Restart Azure Web App
      - name: üîÅ Restart Azure Web App
        run: az webapp restart --resource-group rg-dmc-mobile-dev --name rg-dmc-mobile-dev

      # 11Ô∏è‚É£ Verify Deployment
      - name: ‚úÖ Verify Deployment
        run: |
          echo "üåç Checking if site is live..."
          sleep 30
          curl -f https://mobiledev.travclicks.com/ || echo "Laravel app may still be starting"
